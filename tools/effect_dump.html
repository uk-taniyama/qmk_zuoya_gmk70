<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>RGB Matrix Effects Gallery (Shared Timer)</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
    }
    .effect {
      margin-bottom: 24px;
    }
    .name {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    canvas {
      background: #000;
      border: 1px solid #444;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>

<h1>RGB Matrix Effects Gallery</h1>
<div id="effects"></div>

<script>
const LED_SIZE = 16;

let effects = [];
const renderTargets = [];
let globalTick = 0;

function renderFrame(target) {
  const { ctx, effect } = target;

  if (effect.frames.length === 0) {
    console.warn(`Effect "${effect.name}" has no frames.`);
    return;
  }

  const frameIndex = globalTick % effect.frames.length;
  const frame = effect.frames[frameIndex];

  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

  for (let i = 0; i < frame.length; i++) {
    const { r, g, b } = frame[i];
    const x = i % effect.cols;
    const y = Math.floor(i / effect.cols);

    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(
      x * LED_SIZE,
      y * LED_SIZE,
      LED_SIZE,
      LED_SIZE
    );
  }
}

function tick() {
  for (const target of renderTargets) {
    renderFrame(target);
  }
  globalTick++;
}

// JSON 読み込み
$.getJSON("effect_dump.json", json => {
  effects = json;

  const frames = effects[0].frames;
  for(let i = 0; i < frames.length; i++) {
    console.log(`Frame ${i}:`, frames[i]);
  }

  const $container = $("#effects");

  effects.forEach(effect => {
    const $effect = $("<div>").addClass("effect");
    $("<span>")
      .addClass("name")
      .text(effect.name)
      .appendTo($effect);

    const canvas = document.createElement("canvas");
    canvas.width  = effect.cols * LED_SIZE;
    canvas.height = effect.rows * LED_SIZE;
    $effect.append(canvas);
    $container.append($effect);

    renderTargets.push({
      effect,
      ctx: canvas.getContext("2d"),
    });
    tick();
    setInterval(tick, 500);
  });
});
</script>

</body>
</html>
